@page "/admin/orders/{OrderId:int}"
@attribute [Authorize(Roles = "Admin, Sales, Accounting, Warehouse, Logistics")]
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<h3>Chi ti·∫øt ƒê∆°n h√†ng #@OrderId</h3>

@if (CurrentOrder == null)
{
    <LoadingSpinner />
}
else
{
    <!-- PH·∫¶N IN BI√äN B·∫¢N -->
    <div id="printable-area" class="printable-container">
        <div class="invoice-header d-flex align-items-center mb-4">
            <img src="/images/logo.png" class="invoice-logo me-4" alt="Company Logo" />
            <div class="company-details">
                <strong>C√¥ng ty TNHH KBHOME VIETNAM</strong><br />
                Showroom HCM 46 Song H√†nh, Ph∆∞·ªùng B√¨nh Tr∆∞ng, Th√†nh Ph·ªë H·ªì Ch√≠ Minh.<br />
                Hotline: +84 93 189 48 68
            </div>
        </div>

        <h2 class="text-center mt-4">BI√äN B·∫¢N GIAO NH·∫¨N H√ÄNG H√ìA</h2>
        <p class="text-center">S·ªë ƒê∆°n h√†ng: #@CurrentOrder.Id</p>
        <hr />
        <p><strong>Kh√°ch h√†ng:</strong> @CurrentOrder.CustomerName</p>
        <p><strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong> @CurrentOrder.ShippingAddress</p>
        <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> @CurrentOrder.PhoneNumber</p>
        <p><strong>Ng√†y giao h√†ng:</strong> @DateTime.Now.ToString("dd/MM/yyyy")</p>

        <table class="table table-bordered mt-4">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>T√™n S·∫£n ph·∫©m</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>Gi√° ti·ªÅn</th>
                </tr>
            </thead>
            <tbody>
                @{ int count = 1; }
                @foreach (var detail in CurrentOrder.OrderDetails)
                {
                    <tr>
                        <td>@(count++)</td>
                        <td>@detail.ProductName</td>
                        <td>@detail.Quantity</td>
                        <td>@detail.Price.ToString("N0") ‚Ç´</td>
                    </tr>
                }
                <tr class="table-light fw-bold">
                    <td colspan="3" class="text-end">T·ªïng c·ªông:</td>
                    <td>@GetTotalAmount().ToString("N0") ‚Ç´</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- GIAO DI·ªÜN WEB -->
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>ƒê∆°n h√†ng #@CurrentOrder.Id | 
                        <span class="badge @GetStatusBadgeClass(CurrentOrder.Status)">
                            @CurrentOrder.Status
                        </span>
                    </strong>

                    <AuthorizeView Roles="Admin, Logistics">
                        <button class="btn btn-outline-secondary btn-sm" @onclick="Print">
                            <i class="bi bi-printer"></i> In Bi√™n b·∫£n
                        </button>
                    </AuthorizeView>
                </div>
                <div class="card-body">
                    <h4>Th√¥ng tin Kh√°ch h√†ng</h4>
                    <p><strong>T√™n:</strong> @CurrentOrder.CustomerName</p>
                    <p><strong>ƒê·ªãa ch·ªâ:</strong> @CurrentOrder.ShippingAddress</p>
                    <p><strong>SƒêT:</strong> @CurrentOrder.PhoneNumber</p>

                    <hr />
                    <h4>Chi ti·∫øt S·∫£n ph·∫©m</h4>
                    <table class="table table-sm table-striped mt-2">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>T√™n SP</th>
                                <th class="text-center">SL</th>
                                <th class="text-end">Gi√°</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{ int i = 1; }
                            @foreach (var item in CurrentOrder.OrderDetails)
                            {
                                <tr>
                                    <td>@(i++)</td>
                                    <td>@item.ProductName</td>
                                    <td class="text-center">@item.Quantity</td>
                                    <td class="text-end">@item.Price.ToString("N0") ‚Ç´</td>
                                </tr>
                            }
                            <tr class="fw-bold table-light">
                                <td colspan="3" class="text-end">T·ªïng c·ªông:</td>
                                <td class="text-end">@GetTotalAmount().ToString("N0") ‚Ç´</td>
                            </tr>
                        </tbody>
                    </table>

                    <p class="fs-5 fw-bold text-danger text-end mt-3">
                        T·ªïng thanh to√°n: @GetTotalAmount().ToString("N0") ‚Ç´
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header">H√†nh ƒë·ªông</div>
                <div class="card-body">

                    @* üîí N·∫øu ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh ho·∫∑c h·ªßy, ·∫©n to√†n b·ªô ch·ª©c nƒÉng c·∫≠p nh·∫≠t *@
                    @if (IsOrderLocked())
                    {
                        <div class="alert alert-secondary text-center">
                            <i class="bi bi-lock-fill me-2"></i>
                            ƒê∆°n h√†ng n√†y ƒë√£ <strong>@CurrentOrder.Status</strong> ‚Äî kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th√™m.
                        </div>
                    }
                    else
                    {
                        <!-- ADMIN -->
                        <AuthorizeView Roles="Admin">
                            <div class="mb-2">
                                <label>C·∫≠p nh·∫≠t tr·∫°ng th√°i (Admin):</label>
                                <InputSelect class="form-select" @bind-Value="newStatus">
                                    <option value="Ch·ªù x√°c nh·∫≠n">Ch·ªù x√°c nh·∫≠n</option>
                                    <option value="Ch·ªù thanh to√°n">Ch·ªù thanh to√°n</option>
                                    <option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
                                    <option value="S·∫µn s√†ng giao h√†ng">S·∫µn s√†ng giao h√†ng</option>
                                    <option value="ƒêang giao">ƒêang giao</option>
                                    <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                                    <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
                                </InputSelect>
                            </div>
                            <button class="btn btn-primary w-100" @onclick="UpdateStatus">C·∫≠p nh·∫≠t</button>
                        </AuthorizeView>

                        <!-- SALES -->
                        <AuthorizeView Roles="Sales">
                            @if (CurrentOrder.Status == "Ch·ªù x√°c nh·∫≠n")
                            {
                                <div class="mb-2">
                                    <label><strong>Ghi ch√∫ Sales:</strong></label>
                                    <InputTextArea @bind-Value="salesNoteInput" class="form-control" rows="3" />
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" @onclick='async () => { newStatus = "Ch·ªù thanh to√°n"; await UpdateStatus(); }'>X√°c nh·∫≠n ƒë∆°n</button>
                                    <button class="btn btn-danger" @onclick='async () => { newStatus = "ƒê√£ h·ªßy"; await UpdateStatus(); }'>H·ªßy ƒë∆°n</button>
                                </div>
                            }
                        </AuthorizeView>

                        <!-- ACCOUNTING -->
                        <AuthorizeView Roles="Accounting">
                            @if (CurrentOrder.Status == "Ch·ªù thanh to√°n")
                            {
                                <button class="btn btn-success w-100" @onclick='async () => { newStatus = "ƒê√£ thanh to√°n"; await UpdateStatus(); }'>X√°c nh·∫≠n ƒê√£ thanh to√°n</button>
                            }
                        </AuthorizeView>

                        <!-- WAREHOUSE -->
                        <AuthorizeView Roles="Warehouse">
                            @if (CurrentOrder.Status == "ƒê√£ thanh to√°n")
                            {
                                <button class="btn btn-info w-100" @onclick='async () => { newStatus = "S·∫µn s√†ng giao h√†ng"; await UpdateStatus(); }'>X√°c nh·∫≠n ƒê√£ chu·∫©n b·ªã h√†ng</button>
                            }
                        </AuthorizeView>

                        <!-- LOGISTICS -->
                        <AuthorizeView Roles="Logistics">
                            @if (CurrentOrder.Status == "ƒêang giao")
                            {
                                <button class="btn btn-success w-100" @onclick='async () => { newStatus = "Ho√†n th√†nh"; await UpdateStatus(); }'>X√°c nh·∫≠n ƒê√£ giao th√†nh c√¥ng</button>
                            }
                        </AuthorizeView>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int OrderId { get; set; }

    private Order? CurrentOrder;
    private string newStatus = string.Empty;
    private string? salesNoteInput;

    protected override async Task OnInitializedAsync()
    {
        CurrentOrder = await DbContext.Orders
            .Include(o => o.Shipment)
            .Include(o => o.OrderDetails)
            .FirstOrDefaultAsync(o => o.Id == OrderId);

        if (CurrentOrder != null)
        {
            newStatus = CurrentOrder.Status;
            salesNoteInput = CurrentOrder.SalesNotes;
        }
    }

    private bool IsOrderLocked() =>
        CurrentOrder != null && 
        (CurrentOrder.Status == "Ho√†n th√†nh" || CurrentOrder.Status == "ƒê√£ h·ªßy");

    private async Task UpdateStatus()
    {
        if (IsOrderLocked()) return; // üîí Kh√¥ng cho ph√©p c·∫≠p nh·∫≠t n·∫øu ƒë√£ ho√†n th√†nh ho·∫∑c h·ªßy

        if (CurrentOrder != null && !string.IsNullOrEmpty(newStatus))
        {
            CurrentOrder.Status = newStatus;

            if (!string.IsNullOrWhiteSpace(salesNoteInput))
                CurrentOrder.SalesNotes = salesNoteInput;

            if (newStatus == "Ho√†n th√†nh" && CurrentOrder.Shipment != null)
                CurrentOrder.Shipment.DeliveredDate = DateTime.Now;

            await DbContext.SaveChangesAsync();
            StateHasChanged();
        }
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Ho√†n th√†nh" => "bg-success",
        "ƒê√£ h·ªßy" => "bg-danger",
        "ƒêang giao" => "bg-primary",
        "S·∫µn s√†ng giao h√†ng" => "bg-warning text-dark",
        "Ch·ªù thanh to√°n" => "bg-info text-dark",
        _ => "bg-secondary"
    };

    private decimal GetTotalAmount() =>
        (CurrentOrder?.OrderDetails == null)
        ? 0
        : CurrentOrder.OrderDetails.Sum(d => d.Quantity * d.Price);

    private async Task Print() =>
        await JSRuntime.InvokeVoidAsync("triggerPrint");
}
